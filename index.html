<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<title>æ•¸å­¸å¯¶å¯å¤¢å°æˆ°</title>
<link rel="manifest" href="manifest.json"/>
<meta name="theme-color" content="#4338ca"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700;800;900&family=Press+Start+2P&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Noto Sans TC',sans-serif;overflow:hidden;height:100vh;height:100dvh;background:#111;-webkit-user-select:none;user-select:none}
button{font-family:inherit;cursor:pointer;-webkit-tap-highlight-color:transparent}
button:active{transform:scale(0.96)!important}
@keyframes enemyHit{0%{transform:translate(0,0)}10%{transform:translate(8px,-4px)}20%{transform:translate(-6px,2px)}30%{transform:translate(4px,-2px)}50%{transform:translate(0,0)}100%{transform:translate(0,0)}}
@keyframes playerHit{0%{transform:translate(0,0) scaleX(-1)}10%{transform:translate(-8px,4px) scaleX(-1)}20%{transform:translate(6px,-2px) scaleX(-1)}50%{transform:translate(0,0) scaleX(-1)}100%{transform:translate(0,0) scaleX(-1)}}
@keyframes attackLunge{0%{transform:translate(0,0) scaleX(-1)}30%{transform:translate(60px,-40px) scaleX(-1)}50%{transform:translate(60px,-40px) scaleX(-1)}100%{transform:translate(0,0) scaleX(-1)}}
@keyframes enemyAttackLunge{0%{transform:translate(0,0)}30%{transform:translate(-60px,40px)}50%{transform:translate(-60px,40px)}100%{transform:translate(0,0)}}
@keyframes dmgPop{0%{transform:translateY(0) scale(0.5);opacity:0}20%{transform:translateY(-10px) scale(1.2);opacity:1}40%{transform:translateY(-20px) scale(1);opacity:1}100%{transform:translateY(-50px);opacity:0}}
@keyframes flashWhite{0%{filter:brightness(1)}15%{filter:brightness(3)}30%{filter:brightness(1)}45%{filter:brightness(2.5)}60%{filter:brightness(1)}}
@keyframes popIn{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
@keyframes fadeSlide{0%{transform:translateY(12px);opacity:0}100%{transform:translateY(0);opacity:1}}
@keyframes chargeGlow{0%{filter:drop-shadow(0 0 4px rgba(255,200,0,0))}50%{filter:drop-shadow(0 0 16px rgba(255,200,0,0.8))}100%{filter:drop-shadow(0 0 4px rgba(255,200,0,0))}}
@keyframes slideInBattle{0%{transform:translateX(120px);opacity:0}100%{transform:translateX(0);opacity:1}}
@keyframes slideInPlayer{0%{transform:translateX(-120px) scaleX(-1);opacity:0}100%{transform:translateX(0) scaleX(-1);opacity:1}}
@keyframes sparkle{0%{transform:scale(0) rotate(0deg);opacity:1}50%{transform:scale(1) rotate(180deg);opacity:1}100%{transform:scale(0) rotate(360deg);opacity:0}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
@keyframes floatFlip{0%,100%{transform:translateY(0) scaleX(-1)}50%{transform:translateY(-6px) scaleX(-1)}}
@keyframes timerShrink{0%{width:100%}100%{width:0%}}
@keyframes timerPulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
@keyframes timerUrgent{0%{background:#ef4444}50%{background:#fbbf24}100%{background:#ef4444}}
@keyframes fireballFly{0%{transform:translate(0,0) scale(0.3);opacity:0}15%{transform:translate(20px,-10px) scale(1);opacity:1}85%{transform:translate(160px,-80px) scale(1.2);opacity:1}100%{transform:translate(180px,-90px) scale(0.5);opacity:0}}
@keyframes fireTrail{0%{transform:translate(0,0) scale(0);opacity:0}10%{opacity:0.8;transform:scale(1)}100%{transform:translate(-30px,15px) scale(0);opacity:0}}
@keyframes lightningStrike{0%{clip-path:inset(100% 0 0 0);opacity:0}20%{clip-path:inset(0 0 0 0);opacity:1;filter:brightness(2)}40%{opacity:0.3}50%{opacity:1;filter:brightness(3)}70%{opacity:0.2}80%{opacity:1;filter:brightness(2)}100%{opacity:0;filter:brightness(1)}}
@keyframes lightningFlash{0%{background:transparent}10%{background:rgba(251,191,36,0.15)}20%{background:transparent}30%{background:rgba(251,191,36,0.1)}40%{background:transparent}100%{background:transparent}}
@keyframes waterWave{0%{transform:translateX(-100%) scaleY(0.3);opacity:0}20%{transform:translateX(-40%) scaleY(1);opacity:0.8}60%{transform:translateX(60%) scaleY(1.1);opacity:0.7}100%{transform:translateX(120%) scaleY(0.5);opacity:0}}
@keyframes waterDrop{0%{transform:translate(0,0) scale(0);opacity:0}20%{transform:translate(var(--dx),var(--dy)) scale(1);opacity:0.9}100%{transform:translate(var(--dx),calc(var(--dy) + 40px)) scale(0.3);opacity:0}}
@keyframes darkPulse{0%{transform:scale(0);opacity:0;background:rgba(88,28,135,0.8)}30%{transform:scale(1);opacity:0.9}60%{transform:scale(1.8);opacity:0.5;background:rgba(168,85,247,0.3)}100%{transform:scale(2.5);opacity:0}}
@keyframes darkScreenFlash{0%{background:transparent}15%{background:rgba(0,0,0,0.7)}30%{background:rgba(88,28,135,0.4)}50%{background:rgba(0,0,0,0.5)}70%{background:rgba(168,85,247,0.2)}100%{background:transparent}}
@keyframes enemyFireHit{0%{filter:brightness(1)}20%{filter:brightness(2) hue-rotate(-20deg)}40%{filter:brightness(1.3)}60%{filter:brightness(1.8) hue-rotate(-10deg)}100%{filter:brightness(1)}}
@keyframes enemyElecHit{0%{filter:brightness(1);transform:translate(0,0)}10%{filter:brightness(3);transform:translate(3px,0)}20%{filter:brightness(1.5);transform:translate(-3px,0)}30%{filter:brightness(2.5);transform:translate(2px,0)}40%{filter:brightness(1);transform:translate(-2px,0)}50%{filter:brightness(2);transform:translate(0,0)}100%{filter:brightness(1);transform:translate(0,0)}}
@keyframes enemyWaterHit{0%{filter:brightness(1);transform:translate(0,0)}20%{filter:brightness(1.5) saturate(2);transform:translate(8px,0)}40%{filter:brightness(1.2);transform:translate(-4px,0)}60%{filter:brightness(1.3) saturate(1.5);transform:translate(2px,0)}100%{filter:brightness(1);transform:translate(0,0)}}
@keyframes enemyDarkHit{0%{filter:brightness(1);transform:scale(1)}15%{filter:brightness(0.2);transform:scale(0.9)}30%{filter:brightness(3);transform:scale(1.15)}50%{filter:brightness(0.5);transform:scale(0.95)}70%{filter:brightness(2);transform:scale(1.05)}100%{filter:brightness(1);transform:scale(1)}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef}=React;

function slimeSVG(c1,c2){return `<ellipse cx="60" cy="82" rx="38" ry="8" fill="rgba(0,0,0,0.12)"/><ellipse cx="60" cy="68" rx="34" ry="28" fill="${c2}"/><ellipse cx="60" cy="65" rx="32" ry="26" fill="${c1}"/><ellipse cx="60" cy="65" rx="32" ry="26" fill="url(#gs)"/><ellipse cx="60" cy="55" rx="18" ry="14" fill="white" opacity="0.15"/><ellipse cx="48" cy="60" rx="7" ry="8.5" fill="white"/><ellipse cx="72" cy="60" rx="7" ry="8.5" fill="white"/><ellipse cx="49.5" cy="62" rx="4.5" ry="5.5" fill="#1a1a2e"/><ellipse cx="73.5" cy="62" rx="4.5" ry="5.5" fill="#1a1a2e"/><ellipse cx="51" cy="60.5" rx="2" ry="2.5" fill="white"/><ellipse cx="75" cy="60.5" rx="2" ry="2.5" fill="white"/><path d="M52,74 Q60,80 68,74" stroke="${c2}" stroke-width="2.5" fill="none" stroke-linecap="round"/><circle cx="40" cy="55" r="4" fill="${c1}" opacity="0.5" filter="url(#glow)"/>`;}

function fireLizardSVG(c1,c2){return `<ellipse cx="60" cy="82" rx="36" ry="7" fill="rgba(0,0,0,0.12)"/><path d="M40,73 Q30,52 37,42 Q42,35 49,38 L51,32 Q56,23 60,23 Q64,23 69,32 L71,38 Q78,35 83,42 Q90,52 80,73 Z" fill="${c2}"/><path d="M42,71 Q33,54 39,44 Q44,38 50,40 L52,34 Q56,26 60,26 Q64,26 68,34 L70,40 Q76,38 81,44 Q87,54 78,71 Z" fill="${c1}"/><path d="M42,71 Q33,54 39,44 Q44,38 50,40 L52,34 Q56,26 60,26 Q64,26 68,34 L70,40 Q76,38 81,44 Q87,54 78,71 Z" fill="url(#gs)"/><path d="M52,28 Q56,12 60,10 Q64,12 68,28" fill="#fbbf24" opacity="0.8"/><path d="M55,28 Q58,16 60,14 Q62,16 65,28" fill="#fde68a"/><ellipse cx="50" cy="52" rx="6.5" ry="8" fill="white"/><ellipse cx="70" cy="52" rx="6.5" ry="8" fill="white"/><ellipse cx="51.5" cy="54" rx="4" ry="5" fill="#1a1a2e"/><ellipse cx="71.5" cy="54" rx="4" ry="5" fill="#1a1a2e"/><ellipse cx="53" cy="52.5" rx="1.8" ry="2.2" fill="#ef4444"/><ellipse cx="73" cy="52.5" rx="1.8" ry="2.2" fill="#ef4444"/><path d="M53,66 Q56,62 60,66 Q64,62 67,66" stroke="white" stroke-width="1.5" fill="none"/><ellipse cx="60" cy="70" rx="12" ry="6" fill="${c2}" opacity="0.3"/>`;}

function ghostSVG(c1,c2){return `<ellipse cx="60" cy="84" rx="30" ry="5" fill="rgba(0,0,0,0.08)"/><path d="M32,55 Q32,25 60,23 Q88,25 88,55 L88,68 Q84,61 80,68 Q76,61 72,68 Q68,61 64,68 Q60,61 56,68 Q52,61 48,68 Q44,61 40,68 Q36,61 32,68 Z" fill="${c2}"/><path d="M34,55 Q34,28 60,26 Q86,28 86,55 L86,66 Q82,60 78,66 Q74,60 70,66 Q66,60 62,66 Q58,60 54,66 Q50,60 46,66 Q42,60 38,66 Q34,60 34,66 Z" fill="${c1}"/><path d="M34,55 Q34,28 60,26 Q86,28 86,55 L86,66" fill="url(#gs)" opacity="0.5"/><ellipse cx="48" cy="46" rx="10" ry="12" fill="white"/><ellipse cx="72" cy="46" rx="10" ry="12" fill="white"/><ellipse cx="50" cy="48" rx="6" ry="7.5" fill="${c2}"/><ellipse cx="74" cy="48" rx="6" ry="7.5" fill="${c2}"/><ellipse cx="51.5" cy="46.5" rx="2.5" ry="3" fill="white"/><ellipse cx="75.5" cy="46.5" rx="2.5" ry="3" fill="white"/><ellipse cx="60" cy="60" rx="6" ry="5" fill="${c2}" opacity="0.6"/><circle cx="38" cy="38" r="2" fill="white" opacity="0.4"/><circle cx="82" cy="35" r="1.5" fill="white" opacity="0.3"/>`;}

function dragonSVG(c1,c2){return `<ellipse cx="60" cy="84" rx="38" ry="7" fill="rgba(0,0,0,0.12)"/><ellipse cx="60" cy="62" rx="32" ry="26" fill="${c2}"/><ellipse cx="60" cy="60" rx="30" ry="24" fill="${c1}"/><ellipse cx="60" cy="60" rx="30" ry="24" fill="url(#gs)"/><polygon points="32,42 20,12 42,36" fill="${c2}"/><polygon points="34,42 24,16 42,38" fill="${c1}"/><polygon points="88,42 100,12 78,36" fill="${c2}"/><polygon points="86,42 96,16 78,38" fill="${c1}"/><polygon points="54,42 60,18 66,42" fill="${c2}" opacity="0.5"/><ellipse cx="48" cy="54" rx="7" ry="8.5" fill="white"/><ellipse cx="72" cy="54" rx="7" ry="8.5" fill="white"/><ellipse cx="49.5" cy="56" rx="4.5" ry="5.5" fill="#dc2626"/><ellipse cx="73.5" cy="56" rx="4.5" ry="5.5" fill="#dc2626"/><ellipse cx="51" cy="54.5" rx="1.5" ry="2.5" fill="#fbbf24"/><ellipse cx="75" cy="54.5" rx="1.5" ry="2.5" fill="#fbbf24"/><path d="M44,70 L49,65 L54,70 L59,65 L64,70 L69,65 L74,70" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/><line x1="32" y1="48" x2="42" y2="52" stroke="${c2}" stroke-width="2.5" stroke-linecap="round"/><line x1="88" y1="48" x2="78" y2="52" stroke="${c2}" stroke-width="2.5" stroke-linecap="round"/>`;}

function darkLordSVG(c1,c2){return `<ellipse cx="60" cy="86" rx="40" ry="8" fill="rgba(0,0,0,0.15)"/><ellipse cx="60" cy="58" rx="36" ry="32" fill="#0f0f23"/><ellipse cx="60" cy="56" rx="34" ry="30" fill="#1a1a2e"/><ellipse cx="60" cy="56" rx="34" ry="30" fill="url(#gs)" opacity="0.1"/><polygon points="28,32 16,2 40,28" fill="${c1}"/><polygon points="30,32 20,8 40,30" fill="${c2}" opacity="0.6"/><polygon points="92,32 104,2 80,28" fill="${c1}"/><polygon points="90,32 100,8 80,30" fill="${c2}" opacity="0.6"/><polygon points="60,28 50,2 70,2" fill="${c1}"/><polygon points="60,30 53,8 67,8" fill="${c2}" opacity="0.6"/><ellipse cx="46" cy="48" rx="9" ry="10" fill="${c1}"/><ellipse cx="74" cy="48" rx="9" ry="10" fill="${c1}"/><ellipse cx="47.5" cy="50" rx="5.5" ry="6.5" fill="#dc2626"/><ellipse cx="75.5" cy="50" rx="5.5" ry="6.5" fill="#dc2626"/><ellipse cx="49" cy="48.5" rx="2" ry="3" fill="#fbbf24"/><ellipse cx="77" cy="48.5" rx="2" ry="3" fill="#fbbf24"/><path d="M42,68 Q47,62 52,68 Q57,62 62,68 Q67,62 72,68 Q77,62 82,68" stroke="#ef4444" stroke-width="2" fill="none" stroke-linecap="round"/><line x1="30" y1="40" x2="40" y2="46" stroke="${c1}" stroke-width="2.5" stroke-linecap="round"/><line x1="90" y1="40" x2="80" y2="46" stroke="${c1}" stroke-width="2.5" stroke-linecap="round"/><circle cx="30" cy="56" r="3" fill="${c1}" opacity="0.3" filter="url(#glow)"/><circle cx="90" cy="56" r="3" fill="${c1}" opacity="0.3" filter="url(#glow)"/>`;}

function pStage0(c1,c2){return `<ellipse cx="60" cy="80" rx="28" ry="6" fill="rgba(0,0,0,0.1)"/><ellipse cx="60" cy="66" rx="22" ry="20" fill="${c2}"/><ellipse cx="60" cy="64" rx="20" ry="18" fill="${c1}"/><ellipse cx="60" cy="64" rx="20" ry="18" fill="url(#gs)"/><polygon points="52,46 60,30 68,46" fill="#fbbf24"/><polygon points="55,46 60,35 65,46" fill="#fde68a"/><ellipse cx="52" cy="60" rx="5.5" ry="6.5" fill="white"/><ellipse cx="68" cy="60" rx="5.5" ry="6.5" fill="white"/><ellipse cx="53.5" cy="62" rx="3.5" ry="4.5" fill="#1a1a2e"/><ellipse cx="69.5" cy="62" rx="3.5" ry="4.5" fill="#1a1a2e"/><ellipse cx="55" cy="60.5" rx="1.5" ry="2" fill="white"/><ellipse cx="71" cy="60.5" rx="1.5" ry="2" fill="white"/><path d="M54,72 Q60,77 66,72" stroke="${c2}" stroke-width="2" fill="none" stroke-linecap="round"/>`;}

function pStage1(c1,c2){return `<ellipse cx="60" cy="82" rx="32" ry="7" fill="rgba(0,0,0,0.1)"/><ellipse cx="60" cy="64" rx="26" ry="24" fill="${c2}"/><ellipse cx="60" cy="62" rx="24" ry="22" fill="${c1}"/><ellipse cx="60" cy="62" rx="24" ry="22" fill="url(#gs)"/><polygon points="36,46 26,22 44,42" fill="#fbbf24"/><polygon points="38,46 30,26 44,44" fill="#fde68a" opacity="0.7"/><polygon points="84,46 94,22 76,42" fill="#fbbf24"/><polygon points="82,46 90,26 76,44" fill="#fde68a" opacity="0.7"/><ellipse cx="50" cy="56" rx="6.5" ry="7.5" fill="white"/><ellipse cx="70" cy="56" rx="6.5" ry="7.5" fill="white"/><ellipse cx="51.5" cy="58" rx="4" ry="5" fill="#1a1a2e"/><ellipse cx="71.5" cy="58" rx="4" ry="5" fill="#1a1a2e"/><ellipse cx="53" cy="56.5" rx="1.8" ry="2.2" fill="${c1}"/><ellipse cx="73" cy="56.5" rx="1.8" ry="2.2" fill="${c1}"/><path d="M52,70 Q60,76 68,70" stroke="${c2}" stroke-width="2.5" fill="none" stroke-linecap="round"/>`;}

function pStage2(c1,c2){return `<ellipse cx="60" cy="84" rx="36" ry="8" fill="rgba(0,0,0,0.12)"/><ellipse cx="60" cy="60" rx="30" ry="28" fill="${c2}"/><ellipse cx="60" cy="58" rx="28" ry="26" fill="${c1}"/><ellipse cx="60" cy="58" rx="28" ry="26" fill="url(#gs)"/><polygon points="30,40 16,8 42,36" fill="#f59e0b"/><polygon points="32,40 22,14 42,38" fill="#fbbf24" opacity="0.7"/><polygon points="90,40 104,8 78,36" fill="#f59e0b"/><polygon points="88,40 98,14 78,38" fill="#fbbf24" opacity="0.7"/><polygon points="60,32 50,6 70,6" fill="#f59e0b"/><polygon points="60,34 53,12 67,12" fill="#fbbf24" opacity="0.7"/><ellipse cx="48" cy="52" rx="8" ry="9.5" fill="white"/><ellipse cx="72" cy="52" rx="8" ry="9.5" fill="white"/><ellipse cx="49.5" cy="54" rx="5" ry="6" fill="${c1}"/><ellipse cx="73.5" cy="54" rx="5" ry="6" fill="${c1}"/><ellipse cx="51" cy="52.5" rx="2" ry="2.5" fill="white"/><ellipse cx="75" cy="52.5" rx="2" ry="2.5" fill="white"/><path d="M48,68 Q60,78 72,68" stroke="${c2}" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M42,74 Q60,84 78,74" fill="#fbbf24" opacity="0.25"/><circle cx="32" cy="50" r="3" fill="${c1}" opacity="0.3" filter="url(#glow)"/><circle cx="88" cy="50" r="3" fill="${c1}" opacity="0.3" filter="url(#glow)"/>`;}

const MONSTERS=[
  {id:"slime",name:"å²èŠå§†",hp:40,atk:6,c1:"#4ade80",c2:"#16a34a",svgFn:slimeSVG,drops:["ğŸ¬","ğŸ§ª"],mType:"grass",typeIcon:"ğŸŒ¿",typeName:"è‰"},
  {id:"fire",name:"ç«ç„°èœ¥",hp:55,atk:9,c1:"#f87171",c2:"#b91c1c",svgFn:fireLizardSVG,drops:["ğŸ”¥","ğŸ’"],mType:"fire",typeIcon:"ğŸ”¥",typeName:"ç«"},
  {id:"ghost",name:"å¹½éˆé­”",hp:50,atk:8,c1:"#c084fc",c2:"#7e22ce",svgFn:ghostSVG,drops:["ğŸ‘»","â­"],mType:"ghost",typeIcon:"ğŸ‘»",typeName:"éˆ"},
  {id:"dragon",name:"é‹¼éµé¾",hp:80,atk:12,c1:"#60a5fa",c2:"#1d4ed8",svgFn:dragonSVG,drops:["ğŸ‰","ğŸ‘‘"],mType:"steel",typeIcon:"ğŸ›¡ï¸",typeName:"é‹¼"},
  {id:"boss",name:"æš—é»‘é­”ç‹",hp:120,atk:15,c1:"#fbbf24",c2:"#b45309",svgFn:darkLordSVG,drops:["ğŸ‘‘","ğŸ†"],mType:"dark",typeIcon:"ğŸ’€",typeName:"æš—"},
];
// Type effectiveness: TYPE_EFF[moveType][monsterType] = multiplier
// 1.5 = super effective, 0.6 = not very effective, 1.0 = neutral
const TYPE_EFF={
  fire:   {grass:1.5, fire:0.6, ghost:1.5, steel:0.6, dark:1.0},
  electric:{grass:1.0, fire:1.0, ghost:0.6, steel:1.5, dark:1.0},
  water:  {grass:0.6, fire:1.5, ghost:1.0, steel:1.0, dark:1.5},
  dark:   {grass:1.0, fire:1.0, ghost:1.5, steel:0.6, dark:0.6},
};
function getEff(moveType,monType){return(TYPE_EFF[moveType]&&TYPE_EFF[moveType][monType])||1.0;}

// Battle scene themes per monster type
const SCENES={
  grass:{
    sky:"linear-gradient(180deg,#87ceeb 0%,#a8d8ea 30%,#b4e4b4 60%,#90d890 100%)",
    ground:"linear-gradient(180deg,transparent,rgba(34,197,94,0.08) 40%,rgba(34,197,94,0.15))",
    platform1:"rgba(34,197,94,0.25)",platform2:"rgba(34,197,94,0.2)",
    deco:()=><>{[...Array(5)].map((_,i)=><div key={`g${i}`} style={{position:"absolute",bottom:`${8+i*3}%`,left:`${5+i*18}%`,fontSize:14+Math.random()*8,opacity:0.25}}>{"ğŸŒ¿ğŸŒ±ğŸ€ğŸŒ¼ğŸŒ»"[i]}</div>)}<div style={{position:"absolute",top:"5%",right:"30%",fontSize:16,opacity:0.15}}>â˜ï¸</div><div style={{position:"absolute",top:"12%",left:"20%",fontSize:22,opacity:0.1}}>â˜ï¸</div></>
  },
  fire:{
    sky:"linear-gradient(180deg,#7c2d12 0%,#c2410c 25%,#ea580c 50%,#92400e 80%,#451a03 100%)",
    ground:"linear-gradient(180deg,transparent,rgba(234,88,12,0.1) 40%,rgba(154,52,18,0.25))",
    platform1:"rgba(234,88,12,0.3)",platform2:"rgba(234,88,12,0.2)",
    deco:()=><>{[...Array(4)].map((_,i)=><div key={`f${i}`} style={{position:"absolute",bottom:`${5+i*4}%`,left:`${10+i*22}%`,fontSize:12+Math.random()*10,opacity:0.2+Math.random()*0.15,animation:`sparkle ${2+i*0.5}s ease ${i*0.3}s infinite`}}>{"ğŸ”¥ğŸŒ‹ğŸ”¥ğŸ’¨"[i]}</div>)}<div style={{position:"absolute",top:"8%",left:"15%",width:60,height:60,background:"radial-gradient(circle,rgba(251,146,60,0.15),transparent)",borderRadius:"50%"}}/>
    <div style={{position:"absolute",bottom:"15%",right:"5%",width:40,height:50,opacity:0.12}}><svg viewBox="0 0 40 50"><polygon points="10,50 20,10 30,50" fill="#ef4444" opacity="0.5"/><polygon points="5,50 15,20 25,50" fill="#b91c1c" opacity="0.3"/></svg></div></>
  },
  ghost:{
    sky:"linear-gradient(180deg,#1e1b4b 0%,#312e81 25%,#3730a3 50%,#1e1b4b 80%,#0f0b2e 100%)",
    ground:"linear-gradient(180deg,transparent,rgba(99,102,241,0.05) 40%,rgba(67,56,202,0.12))",
    platform1:"rgba(99,102,241,0.15)",platform2:"rgba(99,102,241,0.1)",
    deco:()=><>{[...Array(6)].map((_,i)=><div key={`gh${i}`} style={{position:"absolute",top:`${10+Math.random()*50}%`,left:`${5+i*16}%`,fontSize:8+Math.random()*6,opacity:0.08+Math.random()*0.1,animation:`float ${3+i*0.4}s ease ${i*0.5}s infinite`}}>{"ğŸ‘»âœ¨ğŸŒ™â­ğŸ’«ğŸ”®"[i]}</div>)}<div style={{position:"absolute",top:"5%",right:"25%",width:30,height:30,background:"radial-gradient(circle,rgba(250,250,210,0.12),transparent)",borderRadius:"50%"}}/>
    <div style={{position:"absolute",bottom:"20%",left:"8%",width:80,height:30,background:"rgba(139,92,246,0.06)",borderRadius:"50%",filter:"blur(8px)"}}/>
    <div style={{position:"absolute",top:"20%",left:"60%",width:50,height:50,background:"rgba(139,92,246,0.04)",borderRadius:"50%",filter:"blur(12px)"}}/></>
  },
  steel:{
    sky:"linear-gradient(180deg,#64748b 0%,#94a3b8 20%,#cbd5e1 45%,#94a3b8 70%,#6b7280 100%)",
    ground:"linear-gradient(180deg,transparent,rgba(100,116,139,0.1) 40%,rgba(75,85,99,0.2))",
    platform1:"rgba(100,116,139,0.3)",platform2:"rgba(100,116,139,0.2)",
    deco:()=><>{/* Metal girders */}
    <div style={{position:"absolute",bottom:"5%",left:"2%",width:"96%",height:8,background:"linear-gradient(90deg,#6b7280,#9ca3af,#6b7280)",opacity:0.15,borderRadius:2}}/>
    <div style={{position:"absolute",bottom:"5%",left:"10%",width:4,height:"30%",background:"linear-gradient(180deg,transparent,#6b7280)",opacity:0.1}}/>
    <div style={{position:"absolute",bottom:"5%",right:"15%",width:4,height:"25%",background:"linear-gradient(180deg,transparent,#6b7280)",opacity:0.1}}/>
    {[...Array(3)].map((_,i)=><div key={`s${i}`} style={{position:"absolute",top:`${12+i*15}%`,left:`${20+i*25}%`,fontSize:10,opacity:0.08}}>{"âš™ï¸ğŸ”©ğŸ›¡ï¸"[i]}</div>)}
    <div style={{position:"absolute",top:"8%",right:"20%",width:80,height:80,border:"2px solid rgba(148,163,184,0.08)",borderRadius:"50%"}}/>
    <div style={{position:"absolute",top:"6%",left:"10%",width:50,height:3,background:"rgba(148,163,184,0.1)",transform:"rotate(-15deg)"}}/></>
  },
  dark:{
    sky:"linear-gradient(180deg,#030712 0%,#0a0415 20%,#1a0a2e 45%,#0f0520 70%,#030712 100%)",
    ground:"linear-gradient(180deg,transparent,rgba(88,28,135,0.06) 40%,rgba(30,10,60,0.2))",
    platform1:"rgba(88,28,135,0.2)",platform2:"rgba(88,28,135,0.15)",
    deco:()=><>{[...Array(8)].map((_,i)=><div key={`d${i}`} style={{position:"absolute",top:`${5+Math.random()*60}%`,left:`${Math.random()*90}%`,width:2+Math.random()*3,height:2+Math.random()*3,background:"white",borderRadius:"50%",opacity:0.1+Math.random()*0.2,animation:`sparkle ${2+Math.random()*3}s ease ${Math.random()*2}s infinite`}}/>)}
    <div style={{position:"absolute",top:"10%",left:"50%",width:100,height:100,background:"radial-gradient(circle,rgba(168,85,247,0.06),transparent)",borderRadius:"50%"}}/>
    <div style={{position:"absolute",bottom:"25%",left:"5%",width:60,height:60,background:"radial-gradient(circle,rgba(139,92,246,0.04),transparent)",borderRadius:"50%"}}/>
    {[0,1,2].map(i=><div key={`p${i}`} style={{position:"absolute",bottom:`${10+i*8}%`,left:`${15+i*30}%`,width:30+i*10,height:2,background:`rgba(168,85,247,${0.04+i*0.02})`,filter:"blur(3px)"}}/>)}</>
  }
};
const PLAYER={c1:"#818cf8",c2:"#4338ca",stages:[
  {name:"æ•¸æ•¸ç¸",emoji:"ğŸ£",svgFn:pStage0},
  {name:"ç®—è¡“ç¸",emoji:"ğŸ¥",svgFn:pStage1},
  {name:"æ•¸å­¸ç‹",emoji:"ğŸ¦…",svgFn:pStage2},
]};
const MOVES_BASE=[
  {name:"ç«èŠ±å½ˆ",icon:"ğŸ”¥",type:"fire",desc:"ç°¡å–®ä¹˜æ³•",basePower:12,range:[2,5],ops:["Ã—"],color:"#ef4444",bg:"#fef2f2"},
  {name:"é›·é›»æ“Š",icon:"âš¡",type:"electric",desc:"ä¹ä¹ä¹˜æ³•",basePower:20,range:[2,9],ops:["Ã—"],color:"#f59e0b",bg:"#fffbeb"},
  {name:"æ°´æµæ³¢",icon:"ğŸŒŠ",type:"water",desc:"åŸºç¤é™¤æ³•",basePower:24,range:[2,9],ops:["Ã·"],color:"#3b82f6",bg:"#eff6ff"},
  {name:"çµ‚æ¥µçˆ†ç ´",icon:"ğŸ’¥",type:"dark",desc:"å¤§æ•¸ä¹˜é™¤æ··åˆ",basePower:40,range:[3,12],ops:["Ã—","Ã·"],color:"#a855f7",bg:"#faf5ff",risky:true},
];
const POWER_CAPS=[19,23,39,60];
const HITS_PER_LVL=3;
const EFX={fire:["ğŸ”¥","âœ¨","ğŸ’«"],electric:["âš¡","âœ¨","ğŸ’¥"],water:["ğŸŒŠ","ğŸ’§","âœ¨"],dark:["ğŸ’¥","â­","ğŸŒŸ"],enemy:["ğŸ’¢","â—"]};

function genQ(m){const{range,ops}=m;const op=ops[Math.floor(Math.random()*ops.length)];let a,b,ans,d;if(op==="Ã—"){a=Math.floor(Math.random()*(range[1]-range[0]+1))+range[0];b=Math.floor(Math.random()*(range[1]-range[0]+1))+range[0];ans=a*b;d=`${a} Ã— ${b}`;}else{b=Math.floor(Math.random()*(range[1]-range[0]+1))+range[0];ans=Math.floor(Math.random()*(range[1]-range[0]+1))+range[0];a=b*ans;d=`${a} Ã· ${b}`;}const ch=new Set([ans]);while(ch.size<4){const w=ans+Math.floor(Math.random()*10)-5;if(w>0&&w!==ans)ch.add(w);}return{display:d,answer:ans,choices:[...ch].sort(()=>Math.random()-0.5),op};}

function MSVG({svgStr,size=120,anim="",style={}}){return<svg width={size} height={size*100/120} viewBox="0 0 120 100" style={{...style,animation:anim||"none"}}><defs><radialGradient id="gs" cx="35%" cy="25%"><stop offset="0%" stopColor="white" stopOpacity="0.5"/><stop offset="100%" stopColor="white" stopOpacity="0"/></radialGradient><filter id="glow"><feGaussianBlur stdDeviation="2" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><g dangerouslySetInnerHTML={{__html:svgStr}}/></svg>;}

function HPBar({cur,max,color,label}){const p=Math.max(0,cur/max*100);const bc=p>50?color:p>25?"#f59e0b":"#ef4444";return<div style={{background:"rgba(0,0,0,0.65)",borderRadius:12,padding:"8px 12px",backdropFilter:"blur(8px)",border:"1px solid rgba(255,255,255,0.1)"}}><div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}><span style={{fontSize:12,fontWeight:800,color:"white"}}>{label}</span><span style={{fontSize:10,color:"rgba(255,255,255,0.5)",fontFamily:"'Press Start 2P',monospace"}}>{Math.max(0,Math.ceil(cur))}/{max}</span></div><div style={{height:8,background:"rgba(255,255,255,0.15)",borderRadius:4,overflow:"hidden"}}><div style={{width:`${p}%`,height:"100%",background:`linear-gradient(90deg,${bc},${bc}cc)`,borderRadius:4,transition:"width 0.6s ease"}}/></div></div>;}
function XPBar({exp,max}){const p=Math.min(100,exp/max*100);return<div style={{height:4,background:"rgba(255,255,255,0.1)",borderRadius:2,overflow:"hidden",marginTop:4}}><div style={{width:`${p}%`,height:"100%",background:"linear-gradient(90deg,#6366f1,#a855f7)",borderRadius:2,transition:"width 0.8s ease"}}/></div>;}
function Dmg({value,x,y,color,onDone}){useEffect(()=>{const t=setTimeout(onDone,1000);return()=>clearTimeout(t);},[]);return<div style={{position:"absolute",left:x,top:y,fontSize:24,fontWeight:900,color,textShadow:`0 2px 8px ${color}88`,animation:"dmgPop 1s ease forwards",pointerEvents:"none",zIndex:100,fontFamily:"'Press Start 2P',monospace"}}>{value}</div>;}
function Part({emoji,x,y,onDone}){const dx=Math.random()*80-40,dy=-(Math.random()*60+20);const[s,setS]=useState({left:x,top:y,opacity:1,transform:"scale(0)"});useEffect(()=>{requestAnimationFrame(()=>setS({left:x+dx,top:y+dy,opacity:0,transform:"scale(1.2)"}));const t=setTimeout(onDone,800);return()=>clearTimeout(t);},[]);return<div style={{position:"absolute",...s,fontSize:18,transition:"all 0.8s ease-out",pointerEvents:"none",zIndex:90}}>{emoji}</div>;}
function FireEffect({onDone}){useEffect(()=>{const t=setTimeout(onDone,900);return()=>clearTimeout(t);},[]);return<div style={{position:"absolute",inset:0,pointerEvents:"none",zIndex:80}}>
{[0,1,2].map(i=><div key={i} style={{position:"absolute",left:"15%",bottom:"40%",fontSize:28+i*6,animation:`fireballFly ${0.7+i*0.1}s ease ${i*0.1}s forwards`,opacity:0}}>ğŸ”¥</div>)}
{[...Array(6)].map((_,i)=><div key={`t${i}`} style={{position:"absolute",left:`${20+i*8}%`,bottom:`${42-i*5}%`,fontSize:12+Math.random()*8,animation:`fireTrail 0.5s ease ${0.15+i*0.08}s forwards`,opacity:0}}>{"ğŸ”¥âœ¨ğŸ’«"[i%3]}</div>)}
</div>;}

function ElecEffect({onDone}){useEffect(()=>{const t=setTimeout(onDone,800);return()=>clearTimeout(t);},[]);
const bolt=`M60,0 L55,30 L70,32 L50,65 L62,42 L48,40 L60,0`;
return<div style={{position:"absolute",inset:0,pointerEvents:"none",zIndex:80,animation:"lightningFlash 0.8s ease"}}>
{[0,1].map(i=><svg key={i} style={{position:"absolute",right:`${12+i*8}%`,top:`${5+i*3}%`,animation:`lightningStrike 0.5s ease ${i*0.15}s both`}} width="60" height="80" viewBox="0 0 80 70"><path d={bolt} fill={i===0?"#fbbf24":"#fde68a"} opacity={1-i*0.3}/></svg>)}
{[...Array(5)].map((_,i)=><div key={`s${i}`} style={{position:"absolute",right:`${8+Math.random()*20}%`,top:`${10+Math.random()*30}%`,fontSize:10+Math.random()*10,animation:`sparkle 0.4s ease ${0.1+i*0.1}s both`}}>âš¡</div>)}
</div>;}

function WaterEffect({onDone}){useEffect(()=>{const t=setTimeout(onDone,1000);return()=>clearTimeout(t);},[]);return<div style={{position:"absolute",inset:0,pointerEvents:"none",zIndex:80,overflow:"hidden"}}>
<div style={{position:"absolute",right:"5%",top:"10%",width:"60%",height:40,background:"linear-gradient(90deg,transparent,rgba(59,130,246,0.5),rgba(96,165,250,0.6),rgba(59,130,246,0.3),transparent)",borderRadius:20,animation:"waterWave 0.8s ease forwards"}}/>
<div style={{position:"absolute",right:"5%",top:"18%",width:"50%",height:30,background:"linear-gradient(90deg,transparent,rgba(96,165,250,0.4),rgba(147,197,253,0.5),transparent)",borderRadius:16,animation:"waterWave 0.8s ease 0.1s forwards",opacity:0}}/>
{[...Array(8)].map((_,i)=><div key={i} style={{position:"absolute",right:`${10+i*5}%`,top:`${8+Math.random()*20}%`,fontSize:10+Math.random()*10,opacity:0,"--dx":`${-20+Math.random()*40}px`,"--dy":`${-10+Math.random()*20}px`,animation:`waterDrop 0.7s ease ${0.2+i*0.06}s forwards`}}>{"ğŸ’§ğŸŒŠğŸ’¦"[i%3]}</div>)}
</div>;}

function DarkEffect({onDone}){useEffect(()=>{const t=setTimeout(onDone,1100);return()=>clearTimeout(t);},[]);return<div style={{position:"absolute",inset:0,pointerEvents:"none",zIndex:80,animation:"darkScreenFlash 1s ease"}}>
{[0,1,2].map(i=><div key={i} style={{position:"absolute",right:"18%",top:"20%",width:60,height:60,borderRadius:"50%",animation:`darkPulse 0.7s ease ${i*0.15}s forwards`}}/>)}
{[...Array(8)].map((_,i)=><div key={`s${i}`} style={{position:"absolute",right:`${5+Math.random()*30}%`,top:`${5+Math.random()*35}%`,fontSize:14+Math.random()*14,animation:`sparkle 0.5s ease ${0.2+i*0.08}s both`}}>{"ğŸ’¥â­ğŸŒŸâœ¨"[i%4]}</div>)}
</div>;}

function TBox({text,onClick}){return<div onClick={onClick} style={{position:"absolute",bottom:0,left:0,right:0,background:"linear-gradient(to top,rgba(15,23,42,0.98),rgba(15,23,42,0.92))",borderTop:"3px solid rgba(255,255,255,0.15)",padding:"16px 20px",minHeight:70,display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer",zIndex:50}}><div style={{fontSize:15,fontWeight:600,color:"white",lineHeight:1.6,animation:"fadeSlide 0.3s ease"}}>{text}</div><div style={{fontSize:10,color:"rgba(255,255,255,0.3)",flexShrink:0,marginLeft:12}}>â–¼</div></div>;}

function App(){
  const[screen,setScreen]=useState("title");const[round,setRound]=useState(0);
  const[timedMode,setTimedMode]=useState(false);
  const TIMER_SEC=5;
  const timerRef=useRef(null);const timerStartRef=useRef(null);
  const[timerLeft,setTimerLeft]=useState(TIMER_SEC);
  const[enemies]=useState(()=>{const order=[0,1,0,2,1,3,2,3,4];return order.map((idx,i)=>{const b=MONSTERS[idx];const sc=1+i*0.12;return{...b,hp:Math.round(b.hp*sc),maxHp:Math.round(b.hp*sc),atk:Math.round(b.atk*sc),lvl:i+1};});});
  const[enemy,setEnemy]=useState(null);const[eHp,setEHp]=useState(0);
  const[pHp,setPHp]=useState(100);const pMax=100;
  const[pExp,setPExp]=useState(0);const[pLvl,setPLvl]=useState(1);const[pStg,setPStg]=useState(0);
  const[streak,setStreak]=useState(0);const[charge,setCharge]=useState(0);
  const[tC,setTC]=useState(0);const[tW,setTW]=useState(0);const[defeated,setDefeated]=useState(0);
  const[mHits,setMHits]=useState([0,0,0,0]);const[mLvls,setMLvls]=useState([1,1,1,1]);const[mLvlUp,setMLvlUp]=useState(null);
  const[phase,setPhase]=useState("menu");const[selIdx,setSelIdx]=useState(null);
  const[q,setQ]=useState(null);const[fb,setFb]=useState(null);const[bText,setBText]=useState("");
  const[dmgs,setDmgs]=useState([]);const[parts,setParts]=useState([]);
  const[eAnim,setEAnim]=useState("");const[pAnim,setPAnim]=useState("");const[answered,setAnswered]=useState(false);
  const[atkEffect,setAtkEffect]=useState(null);
  const[effMsg,setEffMsg]=useState(null); // {text,color} for type effectiveness popup
  const did=useRef(0);const pid=useRef(0);
  const expNext=pLvl*30;
  const getPow=(i)=>Math.min(MOVES_BASE[i].basePower+(mLvls[i]-1)*2,POWER_CAPS[i]);
  const addD=(v,x,y,c)=>{const id=did.current++;setDmgs(f=>[...f,{id,value:v,x,y,color:c}]);};
  const rmD=id=>setDmgs(f=>f.filter(v=>v.id!==id));
  const addP=(type,x,y,n=5)=>{const es=EFX[type]||["âœ¨"];for(let i=0;i<n;i++){const id=pid.current++;setParts(p=>[...p,{id,emoji:es[Math.floor(Math.random()*es.length)],x:x+Math.random()*40-20,y:y+Math.random()*20-10}]);}};
  const rmP=id=>setParts(f=>f.filter(v=>v.id!==id));

  const SCENE_NAMES={grass:"ğŸŒ¿ ç¶ æ„è‰åŸ",fire:"ğŸŒ‹ ç‚ç†±ç«å±±",ghost:"ğŸŒ™ å¹½æš—å¢“åœ°",steel:"âš™ï¸ é‹¼éµè¦å¡",dark:"ğŸ’€ æš—é»‘æ·±æ·µ"};
  const startBattle=(idx)=>{const e=enemies[idx];setEnemy(e);setEHp(e.maxHp);setRound(idx);const sn=SCENE_NAMES[e.mType]||"";setPhase("text");setBText(`ã€${sn}ã€‘é‡ç”Ÿçš„ ${e.name} Lv.${e.lvl} å‡ºç¾äº†ï¼`);setScreen("battle");setEAnim("slideInBattle 0.6s ease");setPAnim("slideInPlayer 0.6s ease");setTimeout(()=>{setEAnim("");setPAnim("");},700);};
  const startGame=()=>{clearTimer();setPHp(100);setPExp(0);setPLvl(1);setPStg(0);setStreak(0);setCharge(0);setTC(0);setTW(0);setDefeated(0);setMHits([0,0,0,0]);setMLvls([1,1,1,1]);setMLvlUp(null);setDmgs([]);setParts([]);setAtkEffect(null);setEffMsg(null);startBattle(0);};

  const onTimeoutRef=useRef(null);
  const clearTimer=()=>{if(timerRef.current){clearInterval(timerRef.current);timerRef.current=null;}};
  const startTimer=()=>{
    clearTimer();setTimerLeft(TIMER_SEC);timerStartRef.current=Date.now();
    timerRef.current=setInterval(()=>{
      const elapsed=(Date.now()-timerStartRef.current)/1000;
      const left=Math.max(0,TIMER_SEC-elapsed);
      setTimerLeft(left);
      if(left<=0){clearTimer();if(onTimeoutRef.current)onTimeoutRef.current();}
    },50);
  };

  const selectMove=(i)=>{if(phase!=="menu")return;setSelIdx(i);setQ(genQ(MOVES_BASE[i]));setFb(null);setAnswered(false);setPhase("question");if(timedMode)startTimer();};

  const onAns=(choice)=>{
    if(answered)return;setAnswered(true);clearTimer();
    const move=MOVES_BASE[selIdx];const correct=choice===q.answer;
    if(correct){
      setFb({correct:true});setTC(c=>c+1);
      const ns=streak+1;setStreak(ns);setCharge(c=>Math.min(c+1,3));
      // Move lvl
      const nh=[...mHits];nh[selIdx]++;setMHits(nh);
      const cl=mLvls[selIdx];let didLvl=false;
      if(nh[selIdx]>=HITS_PER_LVL*cl){const np=move.basePower+cl*2;if(np<=POWER_CAPS[selIdx]){const nl=[...mLvls];nl[selIdx]++;setMLvls(nl);didLvl=true;setMLvlUp(selIdx);setTimeout(()=>setMLvlUp(null),2000);}}
      setTimeout(()=>{
        setPhase("playerAtk");setPAnim("attackLunge 0.6s ease");
        const hitAnims={fire:"enemyFireHit 0.6s ease",electric:"enemyElecHit 0.6s ease",water:"enemyWaterHit 0.7s ease",dark:"enemyDarkHit 0.8s ease"};
        const efxDelay={fire:300,electric:200,water:350,dark:400};
        setTimeout(()=>{
          setPAnim("none");
          // Show move effect overlay
          setAtkEffect(move.type);
          setTimeout(()=>{
            // Calculate damage with type effectiveness
            let dmg=didLvl?move.basePower+mLvls[selIdx]*2:getPow(selIdx);
            if(ns>=5)dmg=Math.round(dmg*1.8);else if(ns>=3)dmg=Math.round(dmg*1.5);
            dmg=Math.round(dmg*(1+pStg*0.15));
            const eff=getEff(move.type,enemy.mType);
            dmg=Math.round(dmg*eff);
            if(eff>1){setEffMsg({text:"æ•ˆæœçµ•ä½³ï¼",color:"#22c55e"});setTimeout(()=>setEffMsg(null),1500);}
            else if(eff<1){setEffMsg({text:"æ•ˆæœä¸å¥½...",color:"#94a3b8"});setTimeout(()=>setEffMsg(null),1500);}
            const newHp=Math.max(0,eHp-dmg);setEHp(newHp);
            // Move-specific hit animation
            setEAnim(hitAnims[move.type]||"enemyHit 0.5s ease");
            const dmgColor={fire:"#ef4444",electric:"#fbbf24",water:"#3b82f6",dark:"#a855f7"}[move.type]||"#ef4444";
            addD(`-${dmg}`,140,55,dmgColor);
            setTimeout(()=>{setEAnim("");setAtkEffect(null);},800);
            if(newHp<=0){setTimeout(()=>{
              const xp=enemy.lvl*15;setPExp(prev=>{const ne=prev+xp;if(ne>=expNext){setPLvl(l=>l+1);setPHp(h=>Math.min(h+20,pMax));if(pStg<2&&(pLvl+1)%3===0)setTimeout(()=>{setPStg(s=>Math.min(s+1,2));setScreen("evolve");},1500);return ne-expNext;}return ne;});
              setDefeated(d=>d+1);const drop=enemy.drops[Math.floor(Math.random()*enemy.drops.length)];
              setBText(`${enemy.name} è¢«æ‰“å€’äº†ï¼ç²å¾— ${xp} ç¶“é©—å€¼ ${drop}`);setPhase("victory");
            },900);}else setTimeout(()=>enemyTurn(),900);
          },efxDelay[move.type]||300);
        },400);
      },600);
    } else {
      setFb({correct:false,answer:q.answer});setTW(w=>w+1);setStreak(0);setCharge(0);
      setTimeout(()=>{
        if(move.risky){const sd=Math.round(getPow(selIdx)*0.4);const nh=Math.max(0,pHp-sd);setPHp(nh);setPAnim("playerHit 0.5s ease");addD(`-${sd}`,40,170,"#ef4444");setTimeout(()=>setPAnim("none"),500);setBText(`${move.name} å¤±æ§äº†ï¼è‡ªå·±å—åˆ° ${sd} å‚·å®³ï¼`);setPhase("text");setTimeout(()=>{if(nh<=0){setPhase("ko");setBText("ä½ çš„å¤¥ä¼´å€’ä¸‹äº†...");setScreen("gameover");}else enemyTurn();},1500);}
        else{setBText("æ”»æ“Šè½ç©ºäº†ï¼");setPhase("text");setTimeout(()=>enemyTurn(),1200);}
      },1000);
    }
  };

  const enemyTurn=()=>{if(!enemy)return;setBText(`${enemy.name} ç™¼å‹•æ”»æ“Šï¼`);setPhase("enemyAtk");setEAnim("enemyAttackLunge 0.6s ease");
    setTimeout(()=>{setEAnim("");const dmg=Math.round(enemy.atk*(0.8+Math.random()*0.4));const nh=Math.max(0,pHp-dmg);setPHp(nh);setPAnim("playerHit 0.5s ease");addD(`-${dmg}`,60,170,"#ef4444");addP("enemy",80,190,4);setTimeout(()=>setPAnim("none"),500);
    if(nh<=0)setTimeout(()=>{setPhase("ko");setBText("ä½ çš„å¤¥ä¼´å€’ä¸‹äº†...");setScreen("gameover");},800);else setTimeout(()=>{setPhase("menu");setBText("");},800);},500);};

  // Timeout handler for timed mode
  const onTimeout=()=>{
    setAnswered(true);setFb({correct:false,answer:q?.answer});setTW(w=>w+1);setStreak(0);setCharge(0);
    setBText("â° æ™‚é–“åˆ°ï¼ä¾†ä¸åŠå‡ºæ‹›ï¼");setPhase("text");
    setTimeout(()=>enemyTurn(),1200);
  };
  // Keep ref updated with latest closure
  useEffect(()=>{onTimeoutRef.current=onTimeout;});
  // Cleanup timer on unmount or phase change away from question
  useEffect(()=>{if(phase!=="question")clearTimer();},[phase]);

  const advance=()=>{if(phase==="text"){setPhase("menu");setBText("");}else if(phase==="victory"){const nx=round+1;if(nx>=enemies.length){setScreen("gameover");}else{setPHp(h=>Math.min(h+10,pMax));startBattle(nx);}}};

  if(screen==="title")return(
    <div style={{height:"100dvh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"linear-gradient(180deg,#0f172a 0%,#1e1b4b 40%,#312e81 100%)",color:"white",padding:24,textAlign:"center",position:"relative",overflow:"hidden"}}>
      <div style={{position:"absolute",top:"8%",left:"12%",fontSize:40,opacity:0.12,animation:"sparkle 3s ease infinite"}}>â­</div>
      <div style={{position:"absolute",top:"18%",right:"18%",fontSize:30,opacity:0.08,animation:"sparkle 4s ease 1s infinite"}}>âœ¨</div>
      <div style={{marginBottom:16,animation:"float 3s ease-in-out infinite"}}><MSVG svgStr={pStage2(PLAYER.c1,PLAYER.c2)} size={150}/></div>
      <h1 style={{fontSize:32,fontWeight:900,marginBottom:4,letterSpacing:2,textShadow:"0 0 30px rgba(99,102,241,0.5)"}}>æ•¸å­¸å¯¶å¯å¤¢</h1>
      <h2 style={{fontSize:18,fontWeight:700,marginBottom:8,opacity:0.6}}>Math Monster Battle</h2>
      <p style={{fontSize:13,opacity:0.4,marginBottom:28,lineHeight:1.7}}>é¸æ“‡æ‹›å¼ â†’ å›ç­”æ•¸å­¸é¡Œ â†’ æ‰“å€’æ€ªç¸ï¼<br/>æŒçºŒä½¿ç”¨åŒä¸€æ‹›å¼å¯ä»¥å‡ç´šå¨åŠ› ğŸ”¥<br/>é€£çºŒç­”å°è“„åŠ›å¿…æ®ºæŠ€ ğŸ’ª</p>
      <div style={{display:"flex",gap:10,marginBottom:12}}>
        <button onClick={()=>{setTimedMode(false);startGame();}} style={{background:"linear-gradient(135deg,#6366f1,#a855f7)",border:"none",color:"white",fontSize:17,fontWeight:800,padding:"14px 28px",borderRadius:50,boxShadow:"0 4px 24px rgba(99,102,241,0.4)",letterSpacing:1}}>âš”ï¸ ä¸€èˆ¬æ¨¡å¼</button>
        <button onClick={()=>{setTimedMode(true);startGame();}} style={{background:"linear-gradient(135deg,#ef4444,#f59e0b)",border:"none",color:"white",fontSize:17,fontWeight:800,padding:"14px 28px",borderRadius:50,boxShadow:"0 4px 24px rgba(239,68,68,0.4)",letterSpacing:1}}>â±ï¸ è¨ˆæ™‚æ¨¡å¼</button>
      </div>
      <div style={{fontSize:11,opacity:0.3,marginBottom:8}}>è¨ˆæ™‚æ¨¡å¼ï¼š5ç§’å…§å›ç­”ï¼Œå¦å‰‡æ€ªç¸æ¶å…ˆæ”»æ“Šï¼</div>
      <div style={{display:"flex",gap:16,marginTop:20,fontSize:12,opacity:0.3}}><div>ğŸ”¥ ä¹˜æ³•</div><div>ğŸŒŠ é™¤æ³•</div><div>ğŸ’¥ æ··åˆ</div><div>âš¡ ä¹ä¹</div></div>
      <div style={{marginTop:36,opacity:0.25,fontSize:11,lineHeight:1.8}}><div>è¨­è¨ˆï¼šChung-Han Hsieh</div><div style={{fontSize:10}}>âœ‰ï¸ ch.hsieh@mx.nthu.edu.tw</div><div>ç¨‹å¼å¯¦ä½œï¼šç”± Claude (Anthropic) å”åŠ©ç”Ÿæˆ</div></div>
    </div>
  );

  if(screen==="evolve"){const st=PLAYER.stages[pStg];return(
    <div style={{height:"100dvh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:"linear-gradient(180deg,#1e1b4b,#312e81,#4338ca)",color:"white",padding:24,textAlign:"center"}}>
      <div style={{fontSize:18,fontWeight:700,opacity:0.7,marginBottom:12,animation:"fadeSlide 0.5s ease"}}>æ­å–œï¼ä½ çš„å¤¥ä¼´é€²åŒ–äº†ï¼</div>
      <div style={{fontSize:48,marginBottom:8,animation:"popIn 0.5s ease 0.3s both"}}>{st.emoji}</div>
      <div style={{animation:"popIn 0.6s ease 0.5s both",marginBottom:12}}><MSVG svgStr={st.svgFn(PLAYER.c1,PLAYER.c2)} size={160}/></div>
      <div style={{fontSize:28,fontWeight:900,animation:"fadeSlide 0.5s ease 0.8s both",marginBottom:8}}>{st.name}</div>
      <div style={{fontSize:14,opacity:0.6,marginBottom:32}}>æ”»æ“ŠåŠ›æå‡ï¼ç”Ÿå‘½æ¢å¾©ï¼</div>
      <button onClick={()=>{setScreen("battle");setPhase("menu");setBText("");}} style={{background:"linear-gradient(135deg,#6366f1,#a855f7)",border:"none",color:"white",fontSize:16,fontWeight:700,padding:"12px 36px",borderRadius:50}}>ç¹¼çºŒæˆ°é¬¥ï¼</button>
    </div>
  );}

  if(screen==="gameover"){const won=defeated>=enemies.length;return(
    <div style={{height:"100dvh",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",background:won?"linear-gradient(180deg,#1e1b4b,#312e81,#4338ca)":"linear-gradient(180deg,#1e1b4b,#1a0a2e,#0f0520)",color:"white",padding:24,textAlign:"center"}}>
      <div style={{fontSize:64,marginBottom:8,animation:"popIn 0.5s ease"}}>{won?"ğŸ†":"ğŸ’€"}</div>
      <h2 style={{fontSize:26,fontWeight:900,marginBottom:16}}>{won?"æ­å–œé€šé—œï¼":"æŒ‘æˆ°çµæŸ"}{timedMode&&<span style={{fontSize:13,fontWeight:700,background:"rgba(239,68,68,0.3)",padding:"2px 10px",borderRadius:12,marginLeft:8,verticalAlign:"middle"}}>â±ï¸ è¨ˆæ™‚</span>}</h2>
      <div style={{background:"rgba(255,255,255,0.08)",borderRadius:16,padding:20,marginBottom:16,minWidth:260,border:"1px solid rgba(255,255,255,0.1)"}}>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,fontSize:14}}>
          <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:"#22c55e"}}>{tC}</div><div style={{opacity:0.5,fontSize:12}}>ç­”å°</div></div>
          <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:"#ef4444"}}>{tW}</div><div style={{opacity:0.5,fontSize:12}}>ç­”éŒ¯</div></div>
          <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:"#f59e0b"}}>{defeated}</div><div style={{opacity:0.5,fontSize:12}}>æ‰“å€’æ€ªç¸</div></div>
          <div style={{textAlign:"center"}}><div style={{fontSize:28,fontWeight:900,color:"#a855f7"}}>Lv.{pLvl}</div><div style={{opacity:0.5,fontSize:12}}>æœ€çµ‚ç­‰ç´š</div></div>
        </div>
        <div style={{marginTop:12,fontSize:13,opacity:0.5}}>æ­£ç¢ºç‡ï¼š{tC+tW>0?Math.round(tC/(tC+tW)*100):0}%</div>
      </div>
      <div style={{background:"rgba(255,255,255,0.05)",borderRadius:12,padding:"12px 16px",marginBottom:20,minWidth:260,border:"1px solid rgba(255,255,255,0.06)"}}>
        <div style={{fontSize:12,opacity:0.4,marginBottom:8}}>æ‹›å¼ç­‰ç´š</div>
        <div style={{display:"flex",gap:10,justifyContent:"center"}}>{MOVES_BASE.map((m,i)=><div key={i} style={{textAlign:"center"}}><div style={{fontSize:18}}>{m.icon}</div><div style={{fontSize:11,fontWeight:700,color:m.color}}>Lv.{mLvls[i]}</div><div style={{fontSize:10,opacity:0.4}}>å¨åŠ›{m.basePower+(mLvls[i]-1)*2}</div></div>)}</div>
      </div>
      <div style={{display:"flex",gap:10}}>
        <button onClick={startGame} style={{background:"linear-gradient(135deg,#6366f1,#a855f7)",border:"none",color:"white",fontSize:16,fontWeight:700,padding:"12px 32px",borderRadius:50}}>ğŸ”„ å†æŒ‘æˆ°</button>
        <button onClick={()=>setScreen("title")} style={{background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",color:"white",fontSize:14,fontWeight:600,padding:"12px 24px",borderRadius:50}}>ğŸ  ä¸»ç•«é¢</button>
      </div>
    </div>
  );}

  if(!enemy)return null;
  const st=PLAYER.stages[pStg];const eSvg=enemy.svgFn(enemy.c1,enemy.c2);const pSvg=st.svgFn(PLAYER.c1,PLAYER.c2);const chargeReady=charge>=3;
  const scene=SCENES[enemy.mType]||SCENES.grass;

  return(
    <div style={{height:"100dvh",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"}}>
      {dmgs.map(d=><Dmg key={d.id} value={d.value} x={d.x} y={d.y} color={d.color} onDone={()=>rmD(d.id)}/>)}
      {parts.map(p=><Part key={p.id} emoji={p.emoji} x={p.x} y={p.y} onDone={()=>rmP(p.id)}/>)}
      {mLvlUp!==null&&<div style={{position:"absolute",top:60,left:"50%",transform:"translateX(-50%)",background:"linear-gradient(135deg,rgba(251,191,36,0.9),rgba(245,158,11,0.9))",color:"white",padding:"6px 18px",borderRadius:20,fontSize:13,fontWeight:700,zIndex:200,animation:"popIn 0.3s ease",boxShadow:"0 4px 16px rgba(245,158,11,0.4)",whiteSpace:"nowrap"}}>{MOVES_BASE[mLvlUp].icon} {MOVES_BASE[mLvlUp].name} å‡ç´šåˆ° Lv.{mLvls[mLvlUp]}ï¼å¨åŠ› â†’ {getPow(mLvlUp)}</div>}

      {/* Move-specific attack effects */}
      {atkEffect==="fire"&&<FireEffect onDone={()=>setAtkEffect(null)}/>}
      {atkEffect==="electric"&&<ElecEffect onDone={()=>setAtkEffect(null)}/>}
      {atkEffect==="water"&&<WaterEffect onDone={()=>setAtkEffect(null)}/>}
      {atkEffect==="dark"&&<DarkEffect onDone={()=>setAtkEffect(null)}/>}

      {/* Type effectiveness popup */}
      {effMsg&&<div style={{position:"absolute",top:"38%",left:"50%",transform:"translateX(-50%)",background:effMsg.color==="#22c55e"?"linear-gradient(135deg,rgba(34,197,94,0.95),rgba(22,163,74,0.95))":"linear-gradient(135deg,rgba(100,116,139,0.9),rgba(71,85,105,0.9))",color:"white",padding:"6px 20px",borderRadius:20,fontSize:14,fontWeight:800,zIndex:200,animation:"popIn 0.3s ease",boxShadow:`0 4px 16px ${effMsg.color}44`,letterSpacing:1}}>{effMsg.text}</div>}

      <div style={{flex:1,position:"relative",minHeight:0,background:scene.sky,transition:"background 1s ease"}}>
        <div style={{position:"absolute",bottom:0,left:0,right:0,height:"45%",background:scene.ground,transition:"background 1s ease"}}/>
        {scene.deco()}
        <div style={{position:"absolute",right:"5%",top:"8%",width:"55%",height:12,background:scene.platform2,borderRadius:"50%",filter:"blur(2px)",transition:"background 0.8s ease"}}/>
        <div style={{position:"absolute",top:10,left:10,right:"42%",zIndex:10}}>
          <HPBar cur={eHp} max={enemy.maxHp} color={enemy.c1} label={`${enemy.typeIcon}${enemy.name} Lv.${enemy.lvl}`}/>
        </div>
        <div style={{position:"absolute",right:"10%",top:"12%",animation:eAnim||"float 3s ease-in-out infinite"}}><MSVG svgStr={eSvg} size={120}/></div>
        <div style={{position:"absolute",left:"2%",bottom:"12%",width:"50%",height:10,background:scene.platform1,borderRadius:"50%",filter:"blur(2px)",transition:"background 0.8s ease"}}/>
        <div style={{position:"absolute",bottom:10,right:10,left:"42%",zIndex:10}}><HPBar cur={pHp} max={pMax} color="#6366f1" label={`${st.name} Lv.${pLvl}`}/><XPBar exp={pExp} max={expNext}/></div>
        <div style={{position:"absolute",left:"6%",bottom:"14%",transform:"scaleX(-1)",animation:pAnim||(phase==="menu"?"floatFlip 3s ease-in-out infinite":"none")}}><MSVG svgStr={pSvg} size={110}/></div>
        {streak>=2&&<div style={{position:"absolute",top:10,right:10,background:"linear-gradient(135deg,#f59e0b,#ef4444)",color:"white",padding:"3px 10px",borderRadius:16,fontSize:11,fontWeight:700,animation:"popIn 0.3s ease",zIndex:20}}>ğŸ”¥ {streak} é€£æ“Šï¼</div>}
        {timedMode&&streak<2&&<div style={{position:"absolute",top:10,right:10,background:"rgba(239,68,68,0.7)",color:"white",padding:"3px 8px",borderRadius:12,fontSize:10,fontWeight:700,zIndex:20,backdropFilter:"blur(4px)"}}>â±ï¸ è¨ˆæ™‚</div>}
        <div style={{position:"absolute",bottom:50,left:10,display:"flex",gap:4,zIndex:20,background:"rgba(0,0,0,0.3)",padding:"3px 8px",borderRadius:10,backdropFilter:"blur(4px)"}}>
          {[0,1,2].map(i=><div key={i} style={{width:11,height:11,borderRadius:6,background:i<charge?"#f59e0b":"rgba(0,0,0,0.15)",border:"2px solid rgba(255,255,255,0.4)",transition:"all 0.3s",animation:i<charge?"chargeGlow 1.5s ease infinite":"none"}}/>)}
          {chargeReady&&<span style={{fontSize:9,color:"#b45309",fontWeight:700,marginLeft:2,animation:"popIn 0.3s ease"}}>MAX!</span>}
        </div>
      </div>

      <div style={{background:"linear-gradient(to top,#0f172a,#1e293b)",borderTop:"3px solid rgba(255,255,255,0.1)",flexShrink:0,minHeight:phase==="question"?210:170,position:"relative"}}>
        {phase==="menu"&&<div style={{padding:10}}><div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:7}}>
          {MOVES_BASE.map((m,i)=>{const locked=m.risky&&!chargeReady;const lv=mLvls[i];const pw=getPow(i);const atCap=pw>=POWER_CAPS[i];const eff=enemy?getEff(m.type,enemy.mType):1;
          return<button key={i} onClick={()=>!locked&&selectMove(i)} style={{background:locked?"rgba(255,255,255,0.03)":eff>1?`linear-gradient(135deg,${m.bg},rgba(34,197,94,0.08))`:eff<1?`linear-gradient(135deg,${m.bg},rgba(148,163,184,0.08))`:m.bg,border:`2px solid ${locked?"rgba(255,255,255,0.08)":eff>1?"#22c55e66":m.color+"44"}`,borderRadius:12,padding:"10px 10px",textAlign:"left",opacity:locked?0.4:1,cursor:locked?"default":"pointer",transition:"all 0.2s",animation:`fadeSlide 0.3s ease ${i*0.05}s both`,position:"relative",overflow:"hidden"}}>
            {lv>1&&<div style={{position:"absolute",top:4,right:eff!==1?40:6,background:atCap?"linear-gradient(135deg,#f59e0b,#ef4444)":m.color,color:"white",fontSize:8,fontWeight:800,padding:"1px 5px",borderRadius:8,fontFamily:"'Press Start 2P',monospace"}}>Lv{lv}</div>}
            {eff>1&&<div style={{position:"absolute",top:4,right:6,background:"#22c55e",color:"white",fontSize:8,fontWeight:800,padding:"1px 5px",borderRadius:8}}>æ•ˆæœâ†‘</div>}
            {eff<1&&<div style={{position:"absolute",top:4,right:6,background:"#64748b",color:"white",fontSize:8,fontWeight:800,padding:"1px 5px",borderRadius:8}}>æ•ˆæœâ†“</div>}
            <div style={{display:"flex",alignItems:"center",gap:5,marginBottom:2}}><span style={{fontSize:16}}>{m.icon}</span><span style={{fontSize:13,fontWeight:700,color:locked?"#64748b":m.color}}>{m.name}</span></div>
            <div style={{fontSize:10,color:locked?"#475569":"#64748b"}}>{m.desc} Â· å¨åŠ› <b style={{color:lv>1?m.color:"inherit"}}>{pw}</b>{eff>1?" Ã—1.5":eff<1?" Ã—0.6":""}{m.risky&&!chargeReady&&" ğŸ”’"}{m.risky&&chargeReady&&" âš¡è“„åŠ›å®Œæˆï¼"}{!m.risky&&!atCap&&lv>1&&" â†‘"}{atCap&&" âœ¦MAX"}</div>
            {!m.risky&&!atCap&&<div style={{height:3,background:"rgba(0,0,0,0.1)",borderRadius:2,marginTop:4,overflow:"hidden"}}><div style={{width:`${(mHits[i]%(HITS_PER_LVL*mLvls[i]))/(HITS_PER_LVL*mLvls[i])*100}%`,height:"100%",background:m.color,borderRadius:2,transition:"width 0.3s"}}/></div>}
          </button>;})}
        </div></div>}

        {phase==="question"&&q&&<div style={{padding:"10px 14px",animation:"fadeSlide 0.25s ease"}}>
          <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:8}}><span style={{fontSize:14}}>{MOVES_BASE[selIdx].icon}</span><span style={{fontSize:13,fontWeight:700,color:"white"}}>{MOVES_BASE[selIdx].name}ï¼</span><span style={{fontSize:11,color:"rgba(255,255,255,0.35)"}}>{timedMode?"â±ï¸ é™æ™‚å›ç­”ï¼":"å›ç­”æ­£ç¢ºæ‰èƒ½å‘½ä¸­"}</span></div>
          <div style={{background:"rgba(255,255,255,0.08)",borderRadius:12,padding:"10px 16px",textAlign:"center",marginBottom:8,border:"1px solid rgba(255,255,255,0.1)",position:"relative",overflow:"hidden"}}>
            {timedMode&&!answered&&<div style={{position:"absolute",bottom:0,left:0,height:4,background:timerLeft<=1.5?"#ef4444":timerLeft<=3?"#f59e0b":"#22c55e",width:`${(timerLeft/TIMER_SEC)*100}%`,borderRadius:2,transition:"width 0.05s linear,background 0.3s",animation:timerLeft<=1.5?"timerPulse 0.4s ease infinite":"none"}}/>}
            <div style={{fontSize:10,color:"rgba(255,255,255,0.35)",marginBottom:2}}>{q.op==="Ã—"?"ä¹˜æ³•é¡Œ":"é™¤æ³•é¡Œ"}</div>
            <div style={{fontSize:30,fontWeight:900,color:"white",letterSpacing:2}}>{q.display} = ?</div>
            {timedMode&&!answered&&<div style={{fontSize:11,fontWeight:700,color:timerLeft<=1.5?"#ef4444":timerLeft<=3?"#f59e0b":"rgba(255,255,255,0.4)",marginTop:2,fontFamily:"'Press Start 2P',monospace",transition:"color 0.3s"}}>{timerLeft.toFixed(1)}s</div>}
          </div>
          {fb&&<div style={{textAlign:"center",marginBottom:4,fontSize:13,fontWeight:700,color:fb.correct?"#22c55e":"#ef4444",animation:"popIn 0.2s ease"}}>{fb.correct?"âœ… å‘½ä¸­ï¼":`âŒ ç­”æ¡ˆæ˜¯ ${fb.answer}`}</div>}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:7}}>
            {q.choices.map((c,i)=>{let bg="rgba(255,255,255,0.08)",bd="rgba(255,255,255,0.15)",co="white";if(fb){if(c===q.answer){bg="rgba(34,197,94,0.2)";bd="#22c55e";co="#22c55e";}else{bg="rgba(255,255,255,0.03)";co="rgba(255,255,255,0.3)";}}return<button key={i} onClick={()=>onAns(c)} disabled={answered} style={{background:bg,border:`2px solid ${bd}`,borderRadius:10,padding:"10px 8px",fontSize:20,fontWeight:700,color:co,transition:"all 0.2s"}}>{c}</button>;})}
          </div>
        </div>}

        {(phase==="text"||phase==="playerAtk"||phase==="enemyAtk"||phase==="victory"||phase==="ko")&&<TBox text={bText} onClick={advance}/>}
      </div>
    </div>
  );
}
ReactDOM.render(<App/>,document.getElementById("root"));
</script>
<script>if('serviceWorker' in navigator){navigator.serviceWorker.register('sw.js');}</script>
</body>
</html>
